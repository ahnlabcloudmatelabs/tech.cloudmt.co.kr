---
feature_image: images/library.chungnam.png
title: "Azure SQL ì˜ data file size ì™€ IOPS ì˜ ë¶ˆí¸í•œ ì§„ì‹¤"
authors: 
- jungwoo kim
categories:
- Tech
date: "2021-12-20T00:00:00Z"
#draft: true
tags:
- Azure SQL Managed Instance
- SQL Server
---

ê¹”ë”í•˜ê²Œ ì •ë¦¬ì •ëˆëœ ë„ì„œê´€ ë‚´ë¶€ ëª¨ìŠµì€ ë§ˆì¹˜, ì˜ ê´€ë¦¬ë˜ê³  ìˆëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë³´ëŠ” ê²ƒ ê°™ë‹¤. ì°¸ê³ ë¡œ ì¸ë„¤ì¼ ì‚¬ì§„ì€ ì¶©ë‚¨ë„ì„œê´€ì´ê³  ë‚˜ë‘ ì•„ë¬´ëŸ° ì—°ê´€ì€ ì—†ë‹¤.

# ì‹œì‘í•˜ê¸°ì— ì•ì„œ

ìš°ë¦¬ê°€ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ì²˜ìŒì—ëŠ” ë¹„ì‹¸ì§€ ì•ŠëŠ”ë° ì´ìƒí•˜ê²Œ ì ì  ë” ë¹„ì‹¸ì§€ëŠ” ëŠë‚Œì ì¸ ëŠë‚Œì´ ìˆë‹¤. ì´ì— ê³¼ê¸ˆ ìµœì í™” ì‘ì—…ì„ ì¢…ì¢… ì§„í–‰í•˜ê³ ëŠ” í•˜ëŠ”ë°, ì–¼ë§ˆ ì „ì— í•œ account ë‚´ì—ì„œ ê³¼ê¸ˆ ìµœì í™”ë¥¼ ìœ„í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í† ë¦¬ì§€ ìµœì í™”ë¥¼ ì§„í–‰í–ˆì—ˆëŠ”ë°, ì´ë•Œ ì „í˜€ ì˜ˆìƒì¹˜ ëª»í•œ ì¼ë“¤ì´ ë²Œì–´ì¡Œì—ˆë˜ ì‚½ì§ˆ ì´ì•¼ê¸°ë¥¼ ê³µìœ í•˜ê³ ì ê¸€ë¡œ ì˜®ê¸´ë‹¤.

# Azure SQL Managed Instance ì€ ì•„ì£¼ ì¢‹ì€ ì„œë¹„ìŠ¤

ë§ˆìš°ìŠ¤ ëª‡ë²ˆì˜ í´ë¦­ìœ¼ë¡œ PaaS DB ê°€ ë–¡í•˜ë‹ˆ ìƒê¸°ê³ , ì•Œì•„ì„œ vnetê³¼ subnetì— ë°°ì¹˜í•´ì£¼ê³ , ì•Œì•„ì„œ public endpointë„ ë§Œë“¤ì–´ì£¼ê³ , ì•Œì•„ì„œ ì—°ê²° êµ¬ì„± ë§Œë“¤ì–´ì£¼ê³ , ì•Œì•„ì„œ PITR êµ¬ì„±í•´ì£¼ê³ , êµ‰ì¥íˆ í¸ë¦¬í•˜ê³  ì¢‹ì€ ì„œë¹„ìŠ¤ì´ë‹¤. _(SQL Managed Instance ë§Œì„¸ğŸ‘)_

í•œë²ˆ ë§Œë“¤ì–´ë†“ìœ¼ë©´ ë©”ì¸í„°ë„ŒìŠ¤ í•  ê²ƒì´ ê±°ì˜ ì—†ë‹¤. login ì¶”ê°€ë¼ë˜ê°€, ì¿¼ë¦¬ íŠœë‹ ì •ë„ ëŠ” í•´ì¤˜ì•¼ ê² ì§€ë§Œ, ë­ ê±°ì˜ ì•Œì•„ì„œ ì˜ ëŒì•„ê°„ë‹¤. ~~ë¬¼ë¡  ê³¼ê¸ˆë„ ì˜ ëŒì•„ê°„ë‹¤~~

![](images/Azure_SQL_PaaS.png)

[Azure SQL Managed Instanceì— ì¡°ê¸ˆ ë” ì•Œì•„ë³´ë ¤ë©´ ì´ ë§í¬ë¥¼ í´ë¦­! https://docs.microsoft.com/ko-kr/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview](https://docs.microsoft.com/ko-kr/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview)

# ë¬¸ì œ ìƒí™©ì˜ ë“±ì¥

> ì–´ë–¤ DB ì˜ reserved storageê°€ 640GiBì´ê³  used storage ëŠ” 400GiB ì •ë„ì˜€ìœ¼ë©°, used storageì˜ 96% ê°€ í•˜ë‚˜ì˜ í…Œì´ë¸”ì— ì§‘ì¤‘ë˜ì–´ ìˆë‹¤. ì´ í…Œì´ë¸”ì„ **tbl_his** ë¼ê³  ë¶€ë¥´ê² ë‹¤. tbl_his ì—ëŠ” ìµœê·¼ 4~5ë…„ê°„ íˆìŠ¤í† ë¦¬ ì„±ê²©ì˜ ë°ì´í„°ê°€ ë‹´ê²¨ ìˆê³ , insert ë§Œ ë˜ê³  ìˆìœ¼ë©° select í•˜ëŠ” ê²½ìš°ëŠ” ê±°ì˜ ì—†ë‹¤ê³  í•œë‹¤.

---

# ë‚´ê°€ ìƒê°í•œ ì†”ë£¨ì…˜

ë°ì´í„° ë³´ì¡´ ê´€ë¦¬ ì •ì±…ì„ ìˆ˜ë¦½í•´ì•¼ê² ë‹¤ê³  íŒë‹¨í–ˆë‹¤. tbl_his ì—ëŠ” ìµœê·¼ 3ê°œì›” ê°„ì˜ ë°ì´í„°ë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ ë°ì´í„°ëŠ” Azure blob storage ë¡œ ì˜®ê¸´ë‹¤ê±°ë‚˜, ë˜ëŠ” ì•„ì¹´ì´ë¸Œ ìš©ë„ì˜ Azure SQL single databaseë¥¼ ì•„ì£¼ ë‚®ì€ tier ë¡œ ìƒì„±í•˜ì—¬, ì•„ì£¼ ê°„í˜¹ ìˆì„ select ì— ëŒ€ì‘í•˜ë©´ ë˜ê² ë‹¤.

tbl_his ì— ìµœê·¼ 3ê°œì›” ê°„ ë°ì´í„°ë§Œ ë‚¨ê¸°ê²Œ ë˜ë©´ mdf ì˜ í¬ê¸°ëŠ” ë„ˆë¬´ í—ë í•´ì ¸ ìˆì„ ê²ƒì´ë‹ˆ shrinkfile notruncate í•œ ì´í›„ì— shrinkfile truncateonly í•˜ë©´ ë˜ê² ë‹¤. í›„í›„ ì¢‹ì•„. ì´ ì •ë„ë©´ ì™„ë²½í•œ í”Œëœì´ê³  ì´ì œ ì´ í”ŒëœëŒ€ë¡œ ì‘ì—…ì„ í•´ì•¼ê² ë‹¤.

![](images/Everyone_has_a_plan.png)
> ëˆ„êµ¬ë‚˜ ê·¸ëŸ´ë“¯í•œ ê³„íšì„ ê°–ê³  ìˆë‹¤. ì³ë§ê¸° ì „ê¹Œì§€ëŠ”. by ì „ì„¤ì˜ Michael Tyson ì˜¹
---

# ì´ì œ ì‘ì—…ì„ ì‹œì‘í•´ë³´ì

ì‘ì—… ìˆœì„œëŠ” ì•„ë˜ì™€ ê°™ì´ êµ¬ì„±í–ˆë‹¤.

1. tbl_his ì™€ ë™ì¼í•œ êµ¬ì¡°ë¥¼ ê°–ëŠ” tbl_his_new í…Œì´ë¸” ìƒì„±.  
 tbl_his_new ì˜ ë…„ì›” ë‹¨ìœ„ë¡œ íŒŒí‹°ì…”ë‹.  
 `1900-01` ~ `2099-12` ê¹Œì§€ íŒŒì¼ê·¸ë£¹ `n`ê°œ. íŒŒì¼ `n`ê°œ.  
 ì´ë•Œ ë‚±ê°œì˜ ë°ì´í„° íŒŒì¼ì€ init size 64 MiB ì— growthëŠ” 16MiB ë¡œ ì„¤ì •.
1. tbl_his ì˜ ìµœê·¼ 3ê°œì›” ë°ì´í„°ë§Œ tbl_his_new í…Œì´ë¸”ì— ë‹´ê¸°.
1. tbl_his ì´ë¦„ ë³€ê²½ -> tbl_his_old
1. tbl_his_new ì´ë¦„ ë³€ê²½ -> tbl_his
1. tbl_his_old í…Œì´ë¸” ì‚­ì œ
1. shrinkfile notruncate
1. shrinkfile truncateonly

ìœ„ ì‘ì—… ì¤‘ì—ì„œ 3ë²ˆê³¼ 4ë²ˆì€ ì„¸ì…˜ì´ ê±°ì˜ ì—†ëŠ” ì‹œê°„ëŒ€ì— ë™ì‹œì— ì²˜ë¦¬í•´ì•¼ ì–´í”Œë¦¬ì¼€ì´ì…˜ ë‹¨ì—ì„œ ì—ëŸ¬ê°€ ë‚˜ì§€ ì•Šì„ ê²ƒì´ë‹¤.  
(ì´ë¥¸ë°” **í…Œì´ë¸” ë°”ê¿”ì¹˜ê¸°** ì „ëµ)

í…Œì´ë¸” ë°”ê¿”ì¹˜ê¸° ì „ëµì„ ì‚¬ìš©í•œ ì´ìœ ëŠ”, tbl_his í…Œì´ë¸”ì—ì„œ ìµœê·¼ 3ê°œì›” ë°ì´í„°ë¥¼ ì œì™¸í•œ ê³¼ê±° ë°ì´í„°ë¥¼ ëª¨ë‘ delete í•˜ëŠ” ì‹œê°„ ë³´ë‹¤, tbl_his í…Œì´ë¸”ì—ì„œ ìµœê·¼ 3ê°œì›” ë°ì´í„°ë§Œ ë³„ë„ì˜ í…Œì´ë¸”ì— ë‹´ëŠ” ì‹œê°„ì´ í›¨ì”¬ ì§§ê²Œ ì†Œìš”ë  ê²ƒìœ¼ë¡œ íŒë‹¨í–ˆê¸° ë–„ë¬¸ì´ë‹¤.

ìœ„ ì‘ì—… ìˆœì„œëŒ€ë¡œ ìˆœì¡°ë¡­ê²Œ ëª¨ë“  ì‘ì—…ì„ ë§ˆì³¤ê³ , ê¹”ë”í•˜ê²Œ ì‰¬ë§í¬ ëœ ì´í›„ì˜ storage utilizationì€ ì•„ë˜ì™€ ê°™ë‹¤.

![](images/storage_check.png)

used storageê°€ 400GiBì—ì„œ 196GiBìœ¼ë¡œ ì ˆë°˜ ìˆ˜ì¤€ìœ¼ë¡œ ì¤„ì–´ë“  ëª¨ìŠµ. used storageë¥¼ ë§ì´ ì¤„ì˜€ìœ¼ë‹ˆ Azure portalì—ì„œ reserved storageë¥¼ ë§ì´ ì¤„ì¼ ìˆ˜ ìˆê² êµ°. ì´ì œ ëª¨ë‘ê°€ í–‰ë³µí•´ì¡Œë‹¤.

---

# ì¥ì• ì˜ ì‹œì‘

![](images/developer_horror.png)

ë©”íŠ¸ë¦­ì„ ê°€ë§Œíˆ ì³ë‹¤ë³´ê³  ìˆë˜ ë‚˜ëŠ” ë­”ê°€ ì„¬ëœ©í•´ì ¸ ì˜¤ëŠ” ê¸°ë¶„ì„ ëŠê¼ˆë‹¤. ì•„ë˜ ë©”íŠ¸ë¦­ì„ ë³´ì.
> ì°¸ê³ ë¡œ ì´ account ë‚´ì˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ í™˜ê²½ì€ .NET Core 2.1 ì´ê³  Azure App Serviceë¥¼ í™œìš©í•˜ì—¬ ì„œë¹„ìŠ¤ ìš´ì˜ ì¤‘ì— ìˆë‹¤.

![](images/metric_01.png)

App Serviceì˜ request metricì´ ìœ„ ê·¸ë¦¼ì²˜ëŸ¼ ê·œì¹™ì ìœ¼ë¡œ ìš”ë™ì„ ì¹˜ê¸° ì‹œì‘í–ˆë‹¤.

![](images/metric_02.png)

Azure SQL Managed Instanceì˜ CPU % ê°’ì€ App Serviceì˜ request metricì˜ íŒ¨í„´ê³¼ ì¼ì¹˜í•˜ê²Œ íŒŒë„ë¥¼ ì³¤ê³  CPU % ê°’ì´ ìµœëŒ€ 95%ê¹Œì§€ ìœ¡ë°•í•˜ì˜€ë‹¤.

![](images/metric_03.png)

App Serviceì˜ response timeì´ë‹¤. Avgê°€ ì €ì •ë„ì¸ë° MaxëŠ” ì–¼ë§ˆë‚˜ ë†’ì•˜ì„ê¹Œ.. ì •ë§ ë§ì€ requests ê°€ ë§¤ìš° ì˜¤ë«ë™ì•ˆ ê¸°ë‹¤ë¦¬ë©° ì‘ë‹µì„±ì´ ëŠë ¤ì¡Œë˜ ê±´ë°, ì´ í¬ìŠ¤íŠ¸ë¥¼ ì“°ê³  ìˆëŠ” ì‹œì ì—ë„ ì € metricì„ ë³´ë©´ ì‹¬ì¥ì´ ë‘ê·¼ê±°ë¦°ë‹¤.

---

# íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

ìƒê°ì„ í•´ë³´ì. í•´ë‹¹ì¼ìì— Appì€ ë³€ê²½ëœ ê²ƒì´ ì—†ê³ , ë³€ê²½ëœ ê²ƒì€ DB ë°–ì— ì—†ë‹¤. ê·¸ëŸ¼ DBì—ì„œë„ ë¬´ì—‡ì´ ë³€ê²½ëì§€? shrink ì‘ì—…ì„ í†µí•´ DBì˜ used storageê°€ ì ˆë°˜ ìˆ˜ì¤€ìœ¼ë¡œ ì¤„ì–´ë“¤ì—ˆê³ , ë°ì´í„° ìš©ëŸ‰ì˜ ëŒ€ë¶€ë¶„ì„ ì°¨ì§€í•˜ê³  ìˆë˜ tbl_his í…Œì´ë¸”ì˜ íŒŒí‹°ì…”ë‹ ì‘ì—…ì„ í†µí•˜ì—¬ ë‹¨ì¼ ë°ì´í„° íŒŒì¼ì˜ ìš©ëŸ‰ì´ ì‘ì•„ì¡Œë‹¤. Appì˜ ìš”ì²­ëŸ‰ì´ íŒŒë„ë¥¼ ì³¤ê³  ìš”ì²­ëŸ‰ì˜ íŒŒë„ì— ë”°ë¼ DBì˜ CPU % ê°’ ì—­ì‹œ íŒŒë„ë¥¼ ì³¤ë‹¤. DB ì—ì„œì˜ Batch request/sec ëŠ” ì¼ì •í–ˆìœ¼ë©° Active worker countê°€ ê±°ì˜ ë‘ë°°ë¡œ ì¦ê°€ë¥¼ í–ˆë‹¤. ê·¸ë ‡ë‹¤ë©´..!

![](images/idea_flash.png)

DBì˜ reserved storage ìš©ëŸ‰ê³¼ used storage ìš©ëŸ‰ì— ë”°ë¼ ë³´ì¥ë˜ëŠ” IOPSê°€ ë‹¤ë¥¸ ê²ƒì¸ê°€? ë¼ëŠ” ê°€ì„¤ì— ë”°ë¼ Azure portalì—ì„œ DBì˜ reserved storage ìš©ëŸ‰ì„ ì¦ì„¤í•´ë³´ì•˜ë‹¤. (ëª‡ë¶„ ì´ë‚´ ì ìš© ì™„ë£Œ)

> í , ê·¸ë˜ë„ ìƒí™©ì€ ë‚˜ì•„ì§€ì§€ ì•Šì•˜ë‹¤.

ì›¹ê²€ìƒ‰ì„ í†µí•˜ì—¬ ëª‡ê°€ì§€ ìƒˆë¡œìš´ ì¸ì‚¬ì´íŠ¸ë¥¼ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤. Azure SQL Managed Instanceì— ì¥ì°©ë˜ì–´ ìˆëŠ” Premium storage disk ì—ëŠ” disk size ê³„ì¸µì— ë”°ë¼ ê°ê¸° ë‹¤ë¥¸ maximum IOPS per disk ì„ ì œê³µí•œë‹¤ëŠ” ê²ƒì´ë‹¤.

Scalability and performance targets for VM disks  
https://docs.microsoft.com/en-us/azure/virtual-machines/disks-scalability-targets

Storage performance best practices and considerations for Azure SQL DB Managed Instance (General Purpose)  
https://techcommunity.microsoft.com/t5/datacat/storage-performance-best-practices-and-considerations-for-azure/ba-p/305525

![](images/Premium_unmanaged_disks_Per-disk_limits.png)

tbl_his í…Œì´ë¸”ì„ íŒŒí‹°ì…”ë‹ í•˜ê¸° ì „ì—ëŠ” Primary íŒŒì¼ê·¸ë£¹ì— ë‹´ê²¨ìˆì—ˆëŠ”ë°, ì´ Primary ë‹¨ì¼ íŒŒì¼ì—ì„œ íŒŒí‹°ì…”ë‹í•˜ë©´ì„œ ë‹¨ì¼ data file sizeê°€ 64MiBë¡œ í™• ì¤„ì–´ë“¤ë©´ì„œ í•´ë‹¹ íŒŒì¼ì˜ IOPS ê°€ 2,300 ì—ì„œ 500 ìœ¼ë¡œ ë–¨ì–´ì§„ ê²ƒìœ¼ë¡œ ì¶”ì •ëœë‹¤.  
ê·¸ë ‡ë‹¤ë©´ ì´ë²ˆì—ëŠ”!

![](images/idea_flash.png)


ê° ê°œë³„ data file sizeë¥¼ 128GiB ë³´ë‹¤ í° ê°’, ì˜ˆë¥¼ ë“¤ì–´ 136GiBìœ¼ë¡œ ëŠ˜ë ¤ ì¥ì•  ìƒí™©ì´ í•´ì†Œë˜ëŠ”ì§€ ì•Œì•„ë³´ê¸°ë¡œ í–ˆë‹¤.

> ì˜¤ì˜¤! ë¬¸ì œê°€ í•´ê²°ë˜ì—ˆë‹¤.

ì•„ë˜ ë©”íŠ¸ë¦­ì²˜ëŸ¼ data file sizeë¥¼ ëŠ˜ë¦¬ìë§ˆì Appì˜ requestsê°€ ì¼ì •í•˜ê²Œ ìœ ì…ë˜ëŠ” ê²ƒìœ¼ë¡œ í™•ì¸ëœë‹¤.

![](images/metric_normal_03.png)

ì•„ë˜ ë©”íŠ¸ë¦­ì²˜ëŸ¼, **11:30 AM**ì„ ê¸°ì ìœ¼ë¡œ Appì˜ response time(avg,max) ì´ ì •ìƒ ìˆ˜ì¤€ìœ¼ë¡œ ë‚´ë ¤ê°„ ê²ƒì´ í™•ì¸ëœë‹¤.

![](images/metric_normal_05.png)

ë˜í•œ DBì˜ CPU % ì—­ì‹œ ì•„ë˜ ë©”íŠ¸ë¦­ì²˜ëŸ¼, ê¸°ì¡´ ì¥ì•  ìƒí™©ì—ì„œ ìŠ¤íŒŒì´í¬ ì¹˜ë˜ ëª¨ìŠµì—ì„œ **11:30 AM**ì„ ê¸°ì ìœ¼ë¡œ ìŠ¤íŒŒì´í¬ê°€ ê±°ì˜ ì—†ì–´ì§„ ëª¨ìŠµì´ í™•ì¸ëœë‹¤.

![](images/metric_normal_04.png)

---

# êµí›ˆ

1. Azure SQL Managed Instanceì˜ IOPSëŠ” reserved storage, used storageê°€ ì•„ë‹Œ **data file size**ì— ë”°ë¼ ì œê³µëœë‹¤.

1. ê³¼ê¸ˆ ìµœì í™”í•œë‹¤ê³  ë¬´ì‘ì • ë°ì´í„° ìš©ëŸ‰ì„ ì¤„ì˜€ë‹¤ê°€ëŠ” í­í’ì•¼ê·¼ì„ í•˜ê²Œë  ìˆ˜ ìˆë‹¤.

1. ê¸€ì ë§ì€ ë¸”ë¡œê·¸ë¼ê³  ëŒ€ì¶© ë„˜ê¸°ì§€ ë§ê³  ìì„¸íˆ ì½ì–´ë³´ë©´ ê·¸ ì•ˆì— ì§€í˜œê°€ ë‹´ê²¨ìˆë‹¤.

---

# ì¶”ì‹ 
> ë‹·ë„·ì´ ë¯¸ë˜ ì…ë‹ˆë‹¤. (.NET 6 LTS ë§Œì„¸)

![](images/dotnet_is_future.png)